<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>ì œì£¼ í‚¤ìœ„ ì ì‚°ì˜¨ë„ ëª¨ë‹ˆí„°ë§</title>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 400px; margin: 20px auto; padding: 20px; background: #f8f9fa; }
        .card { background: white; padding: 20px; border-radius: 12px; margin: 10px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .temp { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .gdd { background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb var(--progress)); padding: 12px; border-radius: 8px; }
        .pred { color: #27ae60; font-weight: bold; }
        .progress { color: #3498db; }
        small { color: #7f8c8d; }
    </style>
</head>
<body>
    <h1>ğŸ¥ ì œì£¼ í‚¤ìœ„ ëª¨ë‹ˆí„°ë§</h1>

    <div class="card" id="now">
        <div>ì‹¤ì‹œê°„ ì˜¨ë„</div>
        <div class="temp" id="temp-out">-</div>
        <div>ì™¸ë¶€ / <span id="temp-2dong">-</span> (2ë™) / <span id="temp-3dong">-</span> (3ë™)</div>
    </div>

    <div class="card">
        <div>GDD ì§„í–‰ë„ <span class="progress" id="gdd-progress">-</span></div>
        <div class="gdd">
            <strong id="gdd-total">-</strong> / <span id="gdd-bud">-</span> (ë°œì•„10%)<br>
            <strong id="gdd-total2">-</strong> / <span id="gdd-bloom">-</span> (ë§Œê°œ50%)
        </div>
        <small id="gdd-basis">-</small>
    </div>

    <div class="card">
        <div>ì˜ˆìƒ ê°œí™”ì¼ <span class="progress" id="chill-progress">-</span></div>
        <div class="pred">ë°œì•„10%: <span id="bud-date">-</span></div>
        <div class="pred">ë§Œê°œ50%: <span id="bloom-date">-</span></div>
    </div>

    <div class="card">
        <div>ì¹ ë§ ëˆ„ì  <span id="chill-total">-</span> / 100ì¼</div>
    </div>

    <div class="card">
        <div>ê´€ìˆ˜ ì²˜ë°© (zone_main)</div>
        <div>ëŒ€í‘œ í† ì–‘ìˆ˜ë¶„: <strong id="irr-theta-pct">-</strong>% / ì •ê·œí™” ìˆ˜ë¶„(theta_rel): <strong id="irr-theta-rel">-</strong></div>
        <div>ëª©í‘œ theta_rel: <span id="irr-target">-</span>, ê²°ì†: <span id="irr-deficit">-</span></div>
        <div>ê¶Œì¥ ê´€ìˆ˜: <strong id="irr-needed-min">-</strong>ë¶„ (<span id="irr-needed-mm">-</span> mm)</div>
        <div>ì‚¬ì´í´ ì¶”ì²œ: <span id="irr-cycle">-</span></div>
        <small id="irr-reasons">-</small>
        <hr>
        <div>ê´€ìˆ˜ ì‹œë®¬ë ˆì´ì…˜</div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
            <label>ê°•ìš°ê°•ë„(mm/h) <input id="irr-mmph" type="number" min="0.1" step="0.1" style="width:80px"></label>
            <label>ê´€ìˆ˜ ë¶„ <input id="irr-minutes" type="number" min="0" max="120" step="1" style="width:70px"></label>
            <button id="irr-run">ê³„ì‚°</button>
        </div>
        <small id="irr-sim-result">-</small>
    </div>

    <div style="text-align:center; padding:20px 0; color:#7f8c8d;">
        ìµœì¢… ì—…ë°ì´íŠ¸: <span id="timestamp">-</span><br>
        <button onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <script>
        const toNumber = (value) => {
            if (value === null || value === undefined || value === '') return null;
            const n = Number(value);
            return Number.isFinite(n) ? n : null;
        };

        const fmtTemp = (value) => {
            const n = toNumber(value);
            return n === null ? '-' : `${n.toFixed(1)}Â°C`;
        };

        const pick = (...values) => values.find(v => v !== undefined && v !== null && v !== '');

        const estimateDate = (remaining, dailyGdd = 2.0) => {
            const days = Math.max(0, Math.floor((remaining / Math.max(dailyGdd, 0.5)) * 1.2));
            const d = new Date();
            d.setDate(d.getDate() + days);
            return `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
        };

        fetch('data/status.json')
            .then((r) => r.json())
            .then((data) => {
                const now = data.now || {};
                const gdd = data.gdd || {};
                const chill = data.chill || {};

                // ì‹¤ì‹œê°„
                const outside = pick(now['ì™¸ë¶€_c'], now['ì™¸ë¶€ì˜¨ë„']);
                document.getElementById('temp-out').textContent = fmtTemp(outside);
                document.getElementById('temp-2dong').textContent = fmtTemp(now['2ë™_c']);
                document.getElementById('temp-3dong').textContent = fmtTemp(now['3ë™_c']);

                // GDD ê°’/ëª©í‘œ
                const gddTotal = toNumber(pick(gdd.total, gdd.cum_from_0215, gdd['ëˆ„ì _gdd_0215']));
                const budTarget = toNumber(pick(gdd.target_bud, gdd.H_BUD, 80));
                const bloomTarget = toNumber(pick(gdd.target_bloom, gdd.H_BLOOM, 180));

                document.getElementById('gdd-total').textContent = gddTotal ?? '-';
                document.getElementById('gdd-total2').textContent = gddTotal ?? '-';
                document.getElementById('gdd-bud').textContent = budTarget ?? '-';
                document.getElementById('gdd-bloom').textContent = bloomTarget ?? '-';

                // ì§„í–‰ë¥ (ì—†ìœ¼ë©´ ê³„ì‚°)
                const progress = pick(
                    gdd.progress,
                    (gddTotal !== null && budTarget) ? `${Math.min(100, Math.round((gddTotal / budTarget) * 100))}%` : '-'
                );
                document.getElementById('gdd-progress').textContent = progress;
                document.getElementById('gdd-basis').textContent = pick(gdd.basis, '-');

                // ì˜ˆìƒì¼(ì—†ìœ¼ë©´ ë‹¨ìˆœ ì¶”ì •)
                const budDate = pick(
                    gdd.bud_date,
                    gdd.pred_bud10_date,
                    (gddTotal !== null && budTarget !== null) ? estimateDate(Math.max(0, budTarget - gddTotal)) : 'ê³„ì‚°ì¤‘'
                );
                const bloomDate = pick(
                    gdd.bloom_date,
                    gdd.pred_bloom50_date,
                    (gddTotal !== null && bloomTarget !== null) ? estimateDate(Math.max(0, bloomTarget - gddTotal)) : 'ê³„ì‚°ì¤‘'
                );
                document.getElementById('bud-date').textContent = budDate;
                document.getElementById('bloom-date').textContent = bloomDate;

                // ì¹ ë§
                const chillPct = pick(
                    chill.progress,
                    chill.pct !== undefined ? `${chill.pct}%` : undefined,
                    '-'
                );
                document.getElementById('chill-progress').textContent = chillPct;
                document.getElementById('chill-total').textContent = pick(chill.total_days, chill.cum, '-');


                // ê´€ìˆ˜
                const irrigation = data.irrigation || {};
                const zone = (irrigation.zones || [])[0] || {};
                const rec = zone.recommendation || {};
                const response = zone.response || {};
                const mmDefault = toNumber(rec.mm_per_h) ?? toNumber((irrigation.defaults || {}).mm_per_h) ?? 6;

                document.getElementById('irr-theta-pct').textContent = zone.theta_pct_rep ?? '-';
                document.getElementById('irr-theta-rel').textContent = toNumber(zone.theta_rel) !== null ? Number(zone.theta_rel).toFixed(3) : '-';
                document.getElementById('irr-target').textContent = toNumber(zone.target_theta_rel) !== null ? Number(zone.target_theta_rel).toFixed(2) : '-';
                document.getElementById('irr-deficit').textContent = toNumber(zone.deficit_theta_rel) !== null ? Number(zone.deficit_theta_rel).toFixed(3) : '-';
                document.getElementById('irr-needed-min').textContent = rec.needed_minutes ?? '-';
                document.getElementById('irr-needed-mm').textContent = rec.needed_mm ?? '-';
                document.getElementById('irr-cycle').textContent = rec.cycle?.enabled ? rec.cycle.plan : 'ë‹¨ë°œ ê´€ìˆ˜';
                document.getElementById('irr-reasons').textContent = `ê·¼ê±°: ${(rec.reasons || []).join(', ')} | k=${response.k_theta_rel_per_mm ?? '-'} theta_rel/mm`;

                const mmInput = document.getElementById('irr-mmph');
                const minInput = document.getElementById('irr-minutes');
                const runBtn = document.getElementById('irr-run');
                const simOut = document.getElementById('irr-sim-result');
                mmInput.value = mmDefault;
                minInput.value = rec.needed_minutes ?? 0;

                runBtn.onclick = () => {
                    const mmph = Math.max(0.1, Number(mmInput.value || mmDefault));
                    const minutes = Math.min(120, Math.max(0, Number(minInput.value || 0)));
                    const theta = toNumber(zone.theta_rel) ?? 0;
                    const target = toNumber(zone.target_theta_rel) ?? 0.7;
                    const k = Math.max(0.001, toNumber(response.k_theta_rel_per_mm) ?? 0.04);
                    const predicted = Math.min(1, theta + k * mmph * (minutes / 60));
                    const reached = predicted >= target;
                    simOut.textContent = `ì˜ˆìƒ theta_rel ${predicted.toFixed(3)} (${reached ? 'ëª©í‘œ ë„ë‹¬' : 'ëª©í‘œ ë¯¸ë„ë‹¬'})`;
                };

                // ì‹œê°„
                const tsRaw = pick(data.updated_utc, data.timestamp, now.timestamp);
                const ts = tsRaw ? new Date(tsRaw) : null;
                document.getElementById('timestamp').textContent = (ts && !Number.isNaN(ts.getTime()))
                    ? ts.toLocaleString('ko-KR')
                    : (tsRaw || '-');

                // ì§„í–‰ë„ ë°”
                document.querySelector('.gdd').style.setProperty('--progress', String(progress || '0%'));
            })
            .catch(() => {
                document.getElementById('timestamp').textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨';
            });
    </script>
</body>
</html>
